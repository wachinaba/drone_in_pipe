<?xml version="1.0"?>
<launch>
  <!-- MAVROS -->
  <arg name="fcu_url" default="/dev/ttyACM0:115200" />
  <arg name="respawn_mavros" default="true" />
  <include file="$(find mavros)/launch/px4.launch">
    <arg name="gcs_url" value="" />
    <arg name="fcu_url" value="$(arg fcu_url)" />
    <arg name="respawn_mavros" value="$(arg respawn_mavros)" />
  </include>

  <!-- state publishers -->
  <param name="robot_description" textfile="$(find adrien_driver)/urdf/adrien.urdf" />
  <node name="joint_state_publisher" pkg="joint_state_publisher" type="joint_state_publisher" />
  <node name="robot_state_publisher" pkg="robot_state_publisher" type="robot_state_publisher" />

  <!-- Include sensor_drivers.launch -->
  <include file="$(find adrien_driver)/launch/sensor_drivers.launch" />
  

  <arg name="manager_name" default="multizone_lidar_pointcloud_converters" />
  <arg name="manager_threads" default="20" />
  <node pkg="nodelet" type="nodelet" name="$(arg manager_name)" args="manager" output="screen">
    <param name="num_worker_threads" value="$(arg manager_threads)" />
  </node>

  <!-- transform -->
  <node name="level_plane_tf_broadcaster" pkg="localization_in_pipe"
    type="level_plane_tf_broadcaster"
    output="screen" />

  <node pkg="nodelet" type="nodelet" name="multizone_lidar_pointcloud_transformer_left"
    args="load localization_in_pipe/pointcloud_transform_nodelet $(arg manager_name)">
    <remap from="input" to="/multi_zone_lidar_left/scan" />
    <remap from="output" to="/multi_zone_lidar_left/scan_level_plane" />
    <param name="target_frame" value="level_plane" />
  </node>

  <node pkg="nodelet" type="nodelet" name="multizone_lidar_pointcloud_transformer_right"
    args="load localization_in_pipe/pointcloud_transform_nodelet $(arg manager_name)">
    <remap from="input" to="/multi_zone_lidar_right/scan" />
    <remap from="output" to="/multi_zone_lidar_right/scan_level_plane" />
    <param name="target_frame" value="level_plane" />
  </node>

  <node pkg="nodelet" type="nodelet" name="multizone_lidar_pointcloud_transformer_front_left"
    args="load localization_in_pipe/pointcloud_transform_nodelet $(arg manager_name)">
    <remap from="input" to="/multi_zone_lidar_front_left/scan" />
    <remap from="output" to="/multi_zone_lidar_front_left/scan_level_plane" />
    <param name="target_frame" value="level_plane" />
  </node>

  <node pkg="nodelet" type="nodelet" name="multizone_lidar_pointcloud_transformer_front_right"
    args="load localization_in_pipe/pointcloud_transform_nodelet $(arg manager_name)">
    <remap from="input" to="/multi_zone_lidar_front_right/scan" />
    <remap from="output" to="/multi_zone_lidar_front_right/scan_level_plane" />
    <param name="target_frame" value="level_plane" />
  </node>

  <node pkg="nodelet" type="nodelet" name="multizone_lidar_pointcloud_transformer_rear_left"
    args="load localization_in_pipe/pointcloud_transform_nodelet $(arg manager_name)">
    <remap from="input" to="/multi_zone_lidar_rear_left/scan" />
    <remap from="output" to="/multi_zone_lidar_rear_left/scan_level_plane" />
    <param name="target_frame" value="level_plane" />
  </node>

  <node pkg="nodelet" type="nodelet" name="multizone_lidar_pointcloud_transformer_rear_right"
    args="load localization_in_pipe/pointcloud_transform_nodelet $(arg manager_name)">
    <remap from="input" to="/multi_zone_lidar_rear_right/scan" />
    <remap from="output" to="/multi_zone_lidar_rear_right/scan_level_plane" />
    <param name="target_frame" value="level_plane" />
  </node>

  <node pkg="nodelet" type="nodelet" name="multizone_lidar_pointcloud_transformer_bottom"
    args="load localization_in_pipe/pointcloud_transform_nodelet $(arg manager_name)">
    <remap from="input" to="/multi_zone_lidar_bottom/scan" />
    <remap from="output" to="/multi_zone_lidar_bottom/scan_level_plane" />
    <param name="target_frame" value="level_plane" />
  </node>

  <node pkg="nodelet" type="nodelet" name="multizone_lidar_pointcloud_transformer_top"
    args="load localization_in_pipe/pointcloud_transform_nodelet $(arg manager_name)">
    <remap from="input" to="/multi_zone_lidar_top/scan" />
    <remap from="output" to="/multi_zone_lidar_top/scan_level_plane" />
    <param name="target_frame" value="level_plane" />
  </node>

  <node pkg="nodelet" type="nodelet" name="multizone_lidar_pointcloud_merger"
    args="load localization_in_pipe/pointcloud_merger_nodelet $(arg manager_name)">
    <param name="num_sensors" value="8" />
    <remap from="input_0" to="/multi_zone_lidar_left/scan_level_plane" />
    <remap from="input_1" to="/multi_zone_lidar_right/scan_level_plane" />
    <remap from="input_2" to="/multi_zone_lidar_front_left/scan_level_plane" />
    <remap from="input_3" to="/multi_zone_lidar_front_right/scan_level_plane" />
    <remap from="input_4" to="/multi_zone_lidar_rear_left/scan_level_plane" />
    <remap from="input_5" to="/multi_zone_lidar_rear_right/scan_level_plane" />
    <remap from="input_6" to="/multi_zone_lidar_bottom/scan_level_plane" />
    <remap from="input_7" to="/multi_zone_lidar_top/scan_level_plane" />
    <remap from="merged_pointcloud" to="/multi_zone_lidar/scan_level_plane_merged" />
  </node>

  <node pkg="localization_in_pipe" type="ransac_cylinder_estimator" name="ransac_cylinder_estimator">
    <remap from="input" to="/multi_zone_lidar/scan_level_plane_merged" />
  </node>

</launch>